<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>UTM Student Portal</title>
    <link rel="stylesheet" href="../css/style.css">
    <link rel="shortcut icon" type="image/x-icon" href="../images/logo.png" />
    <script src="https://kit.fontawesome.com/3491f85d9f.js" crossorigin="anonymous"></script>

    <script src="https://www.gstatic.com/firebasejs/10.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.10.0/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.10.0/firebase-firestore.js"></script>
</head>

<body>
    <!-- Header -->
    <header>
        <a href="../index.html">
            <div class="logo-and-title">
                <img id="logo" src="../images/logo.png" alt="Logo">
                <h1>Student Portal</h1>
            </div>
        </a>
        
        <div class="left-widgets">
            <!--Weather Feature-->
            <button id="show-weather">Show Weather</button>
            

            <!--Clock-->
            <iframe title="Clock"
                src="https://free.timeanddate.com/clock/i99yta70/n1187/fn6/fs16/fcfff/tc1e3765/pc1e3765/ftb/pa8/tt0/tw1/tm1/th2/ta1/tb4" 
                frameborder="0" width="162" height="54" id="clock-iframe"
            ></iframe>

         <!-- Dark Mode Toggle -->
         <div class="darkmode-toggle">
            <input type="checkbox" id="darkmode-toggle" onchange="toggleDarkMode()"/>
            <label for="darkmode-toggle">
                <!-- Sun SVG Icon -->
                <svg version="1.1" class="sun" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px"
                    viewBox="0 0 496 496" style="enable-background:new 0 0 496 496;" xml:space="preserve">
                    <rect x="152.994" y="58.921" transform="matrix(0.3827 0.9239 -0.9239 0.3827 168.6176 -118.5145)" width="40.001" height="16"/>
                    <rect x="46.9" y="164.979" transform="matrix(0.9239 0.3827 -0.3827 0.9239 71.29 -12.4346)" width="40.001" height="16"/>
                    <rect x="46.947" y="315.048" transform="matrix(0.9239 -0.3827 0.3827 0.9239 -118.531 50.2116)" width="40.001" height="16"/>
                    <rect x="164.966" y="409.112" transform="matrix(-0.9238 -0.3828 0.3828 -0.9238 168.4872 891.7491)" width="16" height="39.999"/>
                    <rect x="303.031" y="421.036" transform="matrix(-0.3827 -0.9239 0.9239 -0.3827 50.2758 891.6655)" width="40.001" height="16"/>
                    <rect x="409.088" y="315.018" transform="matrix(-0.9239 -0.3827 0.3827 -0.9239 701.898 785.6559)" width="40.001" height="16"/>
                    <rect x="409.054" y="165.011" transform="matrix(-0.9239 0.3827 -0.3827 -0.9239 891.6585 168.6574)" width="40.001" height="16"/>
                    <rect x="315.001" y="46.895" transform="matrix(0.9238 0.3828 -0.3828 0.9238 50.212 -118.5529)" width="16" height="39.999"/>
                    <path d="M248,88c-88.224,0-160,71.776-160,160s71.776,160,160,160s160-71.776,160-160S336.224,88,248,88z M248,392
                        c-79.4,0-144-64.6-144-144s64.6-144,144-144s144,64.6,144,144S327.4,392,248,392z"/>
                    <rect x="240" width="16" height="72"/>
                    <rect x="62.097" y="90.096" transform="matrix(0.7071 0.7071 -0.7071 0.7071 98.0963 -40.6334)" width="71.999" height="16"/>
                    <rect y="240" width="72" height="16"/>
                    <rect x="90.091" y="361.915" transform="matrix(-0.7071 -0.7071 0.7071 -0.7071 -113.9157 748.643)" width="16" height="71.999"/>
                    <rect x="240" y="424" width="16" height="72"/>
                    <rect x="361.881" y="389.915" transform="matrix(-0.7071 -0.7071 0.7071 -0.7071 397.8562 960.6281)" width="71.999" height="16"/>
                    <rect x="424" y="240" width="72" height="16"/>
                    <rect x="389.911" y="62.091" transform="matrix(0.7071 0.7071 -0.7071 0.7071 185.9067 -252.6357)" width="16" height="71.999"/>
                </svg>
         
                <!-- Moon SVG Icon -->
                <svg version="1.1" class="moon" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px"
                    viewBox="0 0 49.739 49.739" style="enable-background:new 0 0 49.739 49.739;" xml:space="preserve">
                    <path d="M25.068,48.889c-9.173,0-18.017-5.06-22.396-13.804C-3.373,23.008,1.164,8.467,13.003,1.979l2.061-1.129l-0.615,2.268
                    c-1.479,5.459-0.899,11.25,1.633,16.306c2.75,5.493,7.476,9.587,13.305,11.526c5.831,1.939,12.065,1.492,17.559-1.258v0
                    c0.25-0.125,0.492-0.258,0.734-0.391l2.061-1.13l-0.585,2.252c-1.863,6.873-6.577,12.639-12.933,15.822
                    C32.639,48.039,28.825,48.888,25.068,48.889z M12.002,4.936c-9.413,6.428-12.756,18.837-7.54,29.253
                    c5.678,11.34,19.522,15.945,30.864,10.268c5.154-2.582,9.136-7.012,11.181-12.357c-5.632,2.427-11.882,2.702-17.752,0.748
                    c-6.337-2.108-11.473-6.557-14.463-12.528C11.899,15.541,11.11,10.16,12.002,4.936z"/>
                </svg>
            </label>
        </div>
    </header>

    <!-- Weather Feature Container -->
    <container id="weather-widget">
        <div id="ww_2f586b574b05f" v='1.3' loc='id' a='{"t":"responsive","lang":"en","sl_lpl":1,"ids":["wl3619"],"font":"Arial",
            "sl_ics":"one_a","sl_sot":"celsius","cl_bkg":"image","cl_font":"#FFFFFF","cl_cloud":"#FFFFFF","cl_persp":"#81D4FA",
            "cl_sun":"#FFC107","cl_moon":"#FFC107","cl_thund":"#FF5722"}'>
                More forecasts: <a href="https://oneweather.org/calgary/30_days/" id="ww_2f586b574b05f_u" target="_blank">Weather forecast Calgary 30 days</a>
        </div>
        <script async src="https://app2.weatherwidget.org/js/?id=ww_2f586b574b05f"></script>
    </container>

    <div id="user-profile"></div>
    <button id="sign-in-button">Sign In With Google</button>
    <button id="sign-out-button">Sign Out</button>
    
    <!-- New Post Form -->
    <div class="new-post">
        <h2>Create A New Post</h2>
        <textarea id="post-title" placeholder="Enter post title"></textarea>
        <textarea id="post-content" placeholder="Enter post content"></textarea>
        <button onclick="createPost()">Post</button>
    </div>

    <!-- Enhanced Search Bar -->
    <div class="search-bar">
        <textarea id="search-field" placeholder="Search for post with title or message"></textarea>
        <button onclick="searchPosts()">Search</button>
    </div>

    <!-- Posts will be dynamically inserted here -->
    <div id="posts-container">
        <!-- Existing posts will be fetched and displayed here -->
    </div>

    <script type="module">
        // Import the functions you need from the SDKs you need
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.10.0/firebase-app.js";
        import { getAuth, GoogleAuthProvider, signInWithPopup, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.10.0/firebase-auth.js";
        import { getFirestore, collection, addDoc, getDocs, query, where, deleteDoc, doc } from "https://www.gstatic.com/firebasejs/10.10.0/firebase-firestore.js";
      
        // Your web app's Firebase configuration
        const firebaseConfig = {
          apiKey: "AIzaSyB036gHwHmbG-r_0VWlu4oifpZWEZJJ6uU",
          authDomain: "utm-student-portal.firebaseapp.com",
          projectId: "utm-student-portal",
          storageBucket: "utm-student-portal.appspot.com",
          messagingSenderId: "708863567163",
          appId: "1:708863567163:web:b81dfb03c1a30e7447431e"
        };
      
        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth();
        const db = getFirestore();
      
        const userProfile = document.getElementById('user-profile');
        const signInButton = document.getElementById('sign-in-button');
        const signOutButton = document.getElementById('sign-out-button');
      
        signInButton.addEventListener('click', () => {
          const provider = new GoogleAuthProvider();
          signInWithPopup(auth, provider)
            .then((result) => {
              console.log('User signed in');
            })
            .catch((error) => {
              console.error('Sign in error', error);
            });
        });
      
        signOutButton.addEventListener('click', () => {
          signOut(auth)
            .then(() => {
              console.log('User signed out');
              signInButton.style.display = 'block';
              signOutButton.style.display = 'none';
              userProfile.style.display = 'none';
            })
            .catch((error) => {
              console.error('Sign out error', error);
            });
        });
      
        onAuthStateChanged(auth, (user) => {
          if (user) {
            // User is signed in
            signInButton.style.display = 'none';
            signOutButton.style.display = 'block';
            userProfile.innerHTML = `<img src="${user.photoURL}" alt="Profile Picture"><p>${user.displayName}</p>`;
          } else {
            // User is signed out
            signInButton.style.display = 'block';
            signOutButton.style.display = 'none';
          }
        });

        window.onload = function() {
            onAuthStateChanged(auth, (user) => {
                if (user) {
                // User is signed in
                signInButton.style.display = 'none';
                signOutButton.style.display = 'block';
                userProfile.innerHTML = `<img src="${user.photoURL}" alt="Profile Picture"><p>${user.displayName}</p>`;
                fetchPosts(); // Fetch posts when a user is signed in
                } else {
                // User is signed out
                signInButton.style.display = 'block';
                signOutButton.style.display = 'none';
                }
            });
        }

        window.createPost = function() {
            const postTitle = document.getElementById('post-title').value;
            const postContent = document.getElementById('post-content').value;
            document.getElementById('post-title').value = '';
            document.getElementById('post-content').value = '';

            addDoc(collection(db, 'posts'), {
                title: postTitle,
                content: postContent,
                userId: auth.currentUser.uid,
            })
                .then((docRef) => {
                console.log('Document written with ID: ', docRef.id);

                // Create a new post element
                const postElement = document.createElement('div');
                postElement.classList.add('post');
                postElement.setAttribute('data-id', docRef.id); // Add the data-id attribute
                postElement.innerHTML = `
                    <h1>${postTitle}</h1>
                    <p>${postContent}</p>
                    <button class="delete-button" onclick="deletePost('${docRef.id}')">Delete</button>
                `;

                // Append the new post element to the posts container
                const postsContainer = document.getElementById('posts-container');
                postsContainer.appendChild(postElement);
                })
                .catch((error) => {
                console.error('Error adding document: ', error);
            });
        }

        function fetchPosts() {
        const postsContainer = document.getElementById('posts-container');
        postsContainer.innerHTML = '';

        const q = query(collection(db, 'posts'), where('userId', '==', auth.currentUser.uid));
        getDocs(q)
            .then((querySnapshot) => {
            querySnapshot.forEach((doc) => {
                const postElement = document.createElement('div');
                postElement.classList.add('post');
                postElement.setAttribute('data-id', doc.id); // Add the data-id attribute
                postElement.innerHTML = `
                <h1>${doc.data().title}</h1>
                <p>${doc.data().content}</p>
                <button class="delete-button" onclick="deletePost('${doc.id}')">Delete</button>
                `;
                postsContainer.appendChild(postElement);
            });
            })
            .catch((error) => {
            console.error('Error getting documents: ', error);
            });
        }

        window.deletePost = function(postId) {
            deleteDoc(doc(db, 'posts', postId))
                .then(() => {
                console.log('Document successfully deleted!');

                // Remove the post element from the page
                const postElement = document.querySelector(`.post[data-id="${postId}"]`);
                postElement.remove();
                })
                .catch((error) => {
                console.error('Error removing document: ', error);
            });
        }
      
        window.searchPosts = function() {
            const searchField = document.getElementById('search-field').value;
            const postsContainer = document.getElementById('posts-container');
            postsContainer.innerHTML = '';

            const q = query(collection(db, 'posts'), where('userId', '==', auth.currentUser.uid));
            getDocs(q)
                .then((querySnapshot) => {
                querySnapshot.forEach((doc) => {
                    // Only show the post if the title or content includes the search text
                    if (doc.data().title.includes(searchField) || doc.data().content.includes(searchField)) {
                    const postElement = document.createElement('div');
                    postElement.classList.add('post');
                    postElement.setAttribute('data-id', doc.id); // Add the data-id attribute
                    postElement.innerHTML = `
                        <h1>${doc.data().title}</h1>
                        <p>${doc.data().content}</p>
                        <button class="delete-button" onclick="deletePost('${doc.id}')">Delete</button>
                    `;
                    postsContainer.appendChild(postElement);
                    }
                });
                })
                .catch((error) => {
                console.error('Error getting documents: ', error);
            });
        }
      </script>          

    <!-- Footer -->
    <footer>
        <a id="suggestion-btn" href="https://github.com/AbdulDevHUb/UTM-Student-Portal/issues/new?">Submit Suggestion</a>

        <div class="social-icons">
            <a href="https://www.instagram.com/uoftmississauga/?hl=en" target="_blank" rel="noopener noreferrer" alt="UTM Instagram Profile" aria-label="UTM Instagram Profile"><i class="fa-brands fa-instagram"></i></a>
            <a href="https://www.facebook.com/UTMississauga/" target="_blank" rel="noopener noreferrer" alt="UTM Facebook Page" aria-label="UTM Facebook Page"><i class="fa-brands fa-facebook"></i></a>
            <a href="https://www.reddit.com/r/UTM/" target="_blank" rel="noopener noreferrer" alt="UTM Reddit Page" aria-label="UTM Reddit Page"><i class="fa-brands fa-reddit"></i></a>
            <a href="https://twitter.com/UTM" target="_blank" rel="noopener noreferrer" alt="UTM Twitter Page" aria-label="UTM Twitter Page"><i class="fa-brands fa-twitter"></i></a>
            <a href="https://www.youtube.com/@utm/videos" target="_blank" rel="noopener noreferrer" alt="UTM YouTube Channel" aria-label="UTM YouTube Channel"><i class="fa-brands fa-youtube"></i></a>
            <a href="https://www.linkedin.com/school/university-of-toronto-mississauga/?originalSubdomain=ca" target="_blank" rel="noopener noreferrer" alt="UTM LinkedIn Profile" aria-label="UTM LinkedIn Profile"><i class="fa-brands fa-linkedin-in"></i></a>
        </div>
    </footer>

    <!-- JavaScript File -->
    <script type="module" src="../js/main.js"></script>
</body>
</html>

